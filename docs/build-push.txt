
Connect Kubernetes.

1.
gcloud artifacts repositories create xp-repo \
  --repository-format=docker \
  --location=europe-west1 \
  --description="Docker images for xp"

2.
gcloud artifacts repositories list --location=europe-west1

3.
gcloud auth configure-docker europe-west1-docker.pkg.dev

Tabii kanka â€” burasÄ± Ã§ok Ã¶nemli. Åu ana kadar yaptÄ±ÄŸÄ±mÄ±z â€œimage build + pushâ€ kÄ±smÄ±nÄ± neden yaptÄ±k / ne yaÅŸadÄ±k / nasÄ±l Ã§Ã¶zdÃ¼k ÅŸeklinde notluk, adÄ±m adÄ±m yazÄ±yorum. (Swarm karÅŸÄ±lÄ±ÄŸÄ±yla da iliÅŸkilendirdim.)

AmaÃ§ neydi?

Kubernetes (ve Argo CD/GitOps) dÃ¼nyasÄ±nda deployâ€™un temel girdisi ÅŸudur:

UygulamanÄ±n Docker imageâ€™Ä± hazÄ±r olacak

Bu image bir registryâ€™ye (Docker Hub / private registry) push edilmiÅŸ olacak

Kubernetes, deploy ederken â€œÅŸu imageâ€™Ä± Ã§ek ve Ã§alÄ±ÅŸtÄ±râ€ der

ğŸ“Œ Swarm karÅŸÄ±lÄ±ÄŸÄ±:

Swarm: docker build â†’ docker push â†’ docker service create --image ...

K8s: docker build â†’ docker push â†’ Deployment image: ...

Bizim hedef: â€œKubernetes Ã§alÄ±ÅŸtÄ±racak bir image Ã¼retmek ve onu GCPâ€™deki registryâ€™ye koymakâ€.

Biz ne yaptÄ±k? (AdÄ±m adÄ±m)
1) GCPâ€™de registry hazÄ±rladÄ±k (Artifact Registry)

Neden? Docker Hub yerine GCPâ€™nin kendi private registryâ€™si.

Repo oluÅŸturduk:

xp-repo (location: europe-west1)

BÃ¶ylece imageâ€™larÄ±n gideceÄŸi yer oluÅŸtu.

ğŸ“Œ Swarm karÅŸÄ±lÄ±ÄŸÄ±: â€œHarbor / private registry kurdumâ€ veya â€œDocker Hub repo aÃ§tÄ±mâ€.

2) Dockerâ€™Ä±n bu registryâ€™ye push atabilmesi iÃ§in auth ayarladÄ±k

Komut:

gcloud auth configure-docker europe-west1-docker.pkg.dev

Neden? Cloud Shellâ€™de docker push yapÄ±nca ÅŸifre sormasÄ±n diye.

ğŸ“Œ Swarm karÅŸÄ±lÄ±ÄŸÄ±: docker login.

3) Projeyi Cloud Shellâ€™e aldÄ±k (git clone)

Komut:

git clone ...

cd devops-test

ls ile Dockerfileâ€™Ä± doÄŸruladÄ±k.

Neden? Cloud Shellâ€™de build alabilmek iÃ§in kod lazÄ±m.

4) Image adÄ±nÄ± â€œGCP registry formatÄ±ndaâ€ belirledik

Image URIâ€™yi bÃ¶yle oluÅŸturduk:

europe-west1-docker.pkg.dev/<PROJECT_ID>/xp-repo/devops-test:v1


Bunu env deÄŸiÅŸkenleriyle set ettik:

PROJECT_ID, REGION, REPO, IMAGE_NAME, TAG

IMAGE_URI=...

Neden? Registryâ€™ye push atabilmek iÃ§in image ismi doÄŸru formatta olmalÄ±.

ğŸ“Œ Swarm karÅŸÄ±lÄ±ÄŸÄ±: my-registry.local/app:tag ÅŸeklinde image taglemek.

5) Local build aldÄ±k (baÅŸardÄ±)

Komut:

docker build -t $IMAGE_URI .

âœ… Bu kÄ±sÄ±m Ã§alÄ±ÅŸtÄ±.

6) Local push denedik (baÅŸaramadÄ±k)

Komut:

docker push $IMAGE_URI

Hata:

connect: connection refused (443)

Ne anlama geliyor?

Bu bir â€œyetki yokâ€ hatasÄ± deÄŸil.

Cloud Shellâ€™in bulunduÄŸu ortamdan docker.pkg.devâ€™e giden network baÄŸlantÄ±sÄ±nda sorun/engelleme oldu.

ğŸ“Œ Swarm karÅŸÄ±lÄ±ÄŸÄ±: â€œBenim makineden registryâ€™ye eriÅŸim yok / firewall / network sorunu.â€

Bu sorunu nasÄ±l Ã§Ã¶zdÃ¼k?
7) Plan B: â€œBuild+Push iÅŸlemini Cloud Buildâ€™a devredelimâ€

MantÄ±k:

â€œBen push atamÄ±yorsam, CI server yapsÄ±n.â€

GCPâ€™de bu CI: Cloud Build

Komut:

gcloud builds submit --tag $IMAGE_URI .

Ama ilk denemede:

PERMISSION_DENIED

7.1) Neden permission denied oldu?

Cloud Build Ã§alÄ±ÅŸtÄ±rmak ve registryâ€™ye yazmak iÃ§in IAM role gerekiyor.

Sen â€œroles/ownerâ€ Ã§Ä±ktÄ±ÄŸÄ±nÄ± gÃ¶rdÃ¼n (ownerâ€™sÄ±n), sonra kendine rolleri verdik:

roles/cloudbuild.builds.editor

roles/artifactregistry.writer

Not: Owner zaten yetki verir ama bazen servis bazlÄ± kontrol iÃ§in rolleri aÃ§Ä±kÃ§a eklemek iÅŸleri netleÅŸtiriyor.

8) Cloud Build, kaynak kodu GCS bucketâ€™a atarken yeni hata Ã§Ä±ktÄ±

Hata:

Cloud Build staging bucket: gs://<project>_cloudbuild

storage.objects.get yetkisi yok

Neden?

Buildâ€™in Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (service account), o bucketâ€™Ä± okuyamÄ±yordu.

8.1) Ã‡Ã¶zÃ¼m

Cloud Build bucketâ€™Ä±na ÅŸu iki service accountâ€™a objectViewer verdik:

${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com

${PROJECT_NUMBER}-compute@developer.gserviceaccount.com

Komutlar:

gcloud storage buckets add-iam-policy-binding ... --role roles/storage.objectViewer

9) Push sÄ±rasÄ±nda bir hata daha: Artifact Registryâ€™ye uploadArtifacts denied

Hata:

artifactregistry.repositories.uploadArtifacts denied

Neden?
Cloud Build pushâ€™u sandÄ±ÄŸÄ±mÄ±z hesapla deÄŸil, ÅŸu hesapla yapÄ±yormuÅŸ:

9788881395-compute@developer.gserviceaccount.com

Bunu tespit ettik:

gcloud builds describe <build-id> --format="value(serviceAccount)"
Ã§Ä±ktÄ±sÄ± compute SAâ€™yÄ± gÃ¶sterdi.

9.1) Ã‡Ã¶zÃ¼m

Artifact Registry repo seviyesinde writer verdik:

cloudbuild SAâ€™ya âœ… (zaten verdin)

compute SAâ€™ya âœ… (asÄ±l gereken buymuÅŸ)

Komut:

gcloud artifacts repositories add-iam-policy-binding xp-repo ... --member serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com --role roles/artifactregistry.writer

10) Son deneme: Cloud Build baÅŸarÄ±lÄ±

Komut:

gcloud builds submit --tag $IMAGE_URI .

SonuÃ§:

STATUS: SUCCESS

Image registryâ€™ye push edildi (layers â€œPushedâ€ gÃ¶rdÃ¼k)

Image artÄ±k hazÄ±r:
âœ… .../xp-repo/devops-test:v1

SonuÃ§: Åu an ne kazandÄ±k?

âœ… Kubernetesâ€™e deploy edebileceÄŸimiz bir image var.
âœ… Bu image GCP Artifact Registryâ€™de duruyor.
âœ… Bundan sonraki adÄ±mda Kubernetes â€œbu imageâ€™Ä± Ã§ek ve Ã§alÄ±ÅŸtÄ±râ€ diyebilecek.

KÄ±sa Ã¶zet (tek satÄ±r)

â€œKod â†’ Docker image â†’ registryâ€™ye push â†’ K8s deployâ€ zincirindeki image + registry kÄ±smÄ±nÄ± tamamladÄ±k.